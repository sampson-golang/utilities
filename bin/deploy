#!/usr/bin/env bash

if ! go test ./... ; then
  echo "Tests failed, refusing to deploy"
  exit 1
fi

# Extract version from version.go
VERSION=$(grep 'Version = ' version.go | sed 's/.*"\(.*\)".*/\1/')

# Print the current version
echo $VERSION

# Create git tags
if [ -z "$VERSION" ]; then
	echo "No version found"
	exit 1
fi

git fetch --tags

if ! git tag -a "$VERSION" -m "Version $VERSION" 2>/dev/null; then
	echo "Tag $VERSION already exists"
else
  git tag -a "v$VERSION" -m "Version $VERSION"
  git push origin "v$VERSION"
  git push origin "$VERSION"
fi

# Push tags
for folder in $(find . -type d -not -path '.' -not -path './.*'); do
  if [ -f "$folder/go.mod" ]; then
    version="$VERSION"
    if [[ -f "$folder/version.go" ]]; then
      version="$(grep 'Version = ' "$folder/version.go" | sed 's/.*"\(.*\)".*/\1/')"
    else
      version="$VERSION"
    fi
    if ! git tag -a "$folder/v$version" -m "Version $version" "$folder"; then
      echo "Tag $folder/v$version already exists"
    else
      git push origin "$folder/v$version"
    fi
  fi
done
